<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>NoKanri</title>

  <link rel="manifest" href="/lite-task/manifest.webmanifest">
  <meta name="theme-color" content="#0b0f14">

  <style>
    :root{
      --bg:#0b0f14;
      --panel: rgba(16,24,38,0.86);
      --panel-border: rgba(255,255,255,0.06);

      --text:#e8eef6;
      --muted:#9aa7b8;

      --cell-off:#0f1826;
      --cell-off-text: rgba(232,238,246,0.40); /* ←薄く */
      --cell-off-border: rgba(255,255,255,0.05);

      --cell-on:#1f6feb;
      --cell-on-text:#ffffff;
      --cell-on-border: rgba(255,255,255,0.18);

      --danger:#d73a49;
    }

    *{ box-sizing:border-box }
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans JP", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header{
      padding: 10px 12px 8px;
      position: sticky;
      top: 0;
      z-index: 10;
      background: linear-gradient(to bottom, rgba(11,15,20,0.96), rgba(11,15,20,0.78));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }

    .row{
      display:flex;
      gap:10px;
      align-items:center;
      flex-wrap:nowrap; /* ← 右上に寄せたいので基本折り返さない */
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    input[type="date"], input[type="number"], input[type="text"]{
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.08);
      background:#0f1726;
      color: var(--text);
      font-size: 16px;
      outline: none;
    }
    input[type="number"]{ width: 110px; }
    input[type="date"]{ width: 170px; }
    input[type="text"]{ width: 100%; }

    .spacer{ flex:1; }

    /* 右上まとめ（ON / 反映 / R） */
    .topRight{
      display:flex;
      gap:8px;
      align-items:center;
    }

    .count{
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 14px;
      padding: 8px 10px;
      display:flex;
      gap:8px;
      align-items: baseline;
      min-width: 74px;
      justify-content:center;
    }
    .count strong{ font-size: 18px; line-height: 1; }
    .count span{ font-size: 12px; color: var(--muted); }

    button{
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.10);
      background:#0f1726;
      color: var(--text);
      cursor:pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      white-space:nowrap;
    }

    /* 反映を小さめに */
    button.apply{
      padding: 8px 10px;
      font-size: 14px;
      background: rgba(31,111,235,0.18);
      border-color: rgba(31,111,235,0.40);
    }

    /* Rをさらに小さめに */
    button.resetR{
      width: 36px;
      height: 36px;
      padding: 0;
      font-size: 14px;
      font-weight: 900;
      background: rgba(215,58,73,0.12);
      border-color: rgba(215,58,73,0.30);
    }

    /* エラーだけ表示（OKは出さない） */
    .msg{
      margin-top: 8px;
      font-size: 12px;
      color: rgba(215,58,73,0.95);
      display:none;
    }
    .msg.show{ display:block; }

    main{ padding: 10px 12px 14px; }

    .wrap{
      background: var(--panel);
      border: 1px solid var(--panel-border);
      border-radius: 16px;
      padding: 10px;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(var(--cols), minmax(0, 1fr));
      gap: 7px;
      align-items: stretch;
    }

    .cell{
      user-select:none;
      -webkit-user-select:none;
      border-radius: 12px;
      border: 1px solid var(--cell-off-border);
      background: var(--cell-off);
      color: var(--cell-off-text);
      padding: 12px 0;
      text-align:center;
      font-size: 14px;
      font-weight: 800;
      line-height: 1;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;

      opacity: 0.45; /* ←未選択をもっと薄く */
    }
    .cell.on{
      background: var(--cell-on);
      color: var(--cell-on-text);
      border-color: var(--cell-on-border);
      box-shadow: 0 8px 18px rgba(31,111,235,0.20);
      opacity: 1;
    }

    /* 画面が狭い端末は2段にして崩れを防ぐ */
    @media (max-width: 420px){
      .row{ flex-wrap:wrap; }
      .spacer{ display:none; }
      .topRight{ width:100%; justify-content:flex-end; }
    }
  </style>
</head>

<body>
  <header>
    <!-- 上段：日付/最大（左） + 右上まとめ（右） -->
    <div class="row">
      <div class="card">
        <input id="dateInput" type="date" />
        <input id="maxNum" type="number" min="1" value="100" />
      </div>

      <div class="spacer"></div>

      <div class="topRight">
        <div class="count" aria-label="ON数">
          <strong id="countOn">0</strong><span>ON</span>
        </div>
        <button id="applyBtn" class="apply">反映</button>
        <button id="resetBtn" class="resetR" title="リセット">R</button>
      </div>
    </div>

    <!-- 下段：消す数字（入力のみ） -->
    <div style="margin-top:10px;">
      <div class="card" style="width:100%;">
        <input id="hideInput" type="text" placeholder="消す数字：56-69, 3, 8" />
      </div>
      <div id="hideMsg" class="msg"></div>
    </div>
  </header>

  <main>
    <div class="wrap">
      <div id="grid" class="grid" style="--cols:10;"></div>
    </div>
  </main>

  <script>
    const STORAGE_KEY = "tap-grid-state-v5";

    const elGrid = document.getElementById("grid");
    const elCountOn = document.getElementById("countOn");
    const elDate = document.getElementById("dateInput");
    const elMaxNum = document.getElementById("maxNum");
    const elHide = document.getElementById("hideInput");
    const elHideMsg = document.getElementById("hideMsg");
    const elApply = document.getElementById("applyBtn");
    const elReset = document.getElementById("resetBtn");

    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        return raw ? JSON.parse(raw) : null;
      }catch(_){ return null; }
    }
    function saveState(state){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
    }
    function todayISO(){
      const d = new Date();
      return new Date(d.getTime() - d.getTimezoneOffset()*60000).toISOString().slice(0,10);
    }
    function defaultState(){
      return { date: todayISO(), max: 100, hide: "", on: {} };
    }

    function validateAndParseHide(text, max){
      const res = { ok:true, set:new Set(), duplicates:new Set(), invalid:[], out:[] };
      const src = (text || "").replace(/\s+/g, "");
      if(!src) return res;

      const parts = src.split(",").filter(Boolean);
      for(const token of parts){
        const r = token.match(/^(\d+)-(\d+)$/);
        if(r){
          let a = Number(r[1]), b = Number(r[2]);
          if(!Number.isFinite(a) || !Number.isFinite(b)){ res.invalid.push(token); continue; }
          if(a>b) [a,b]=[b,a];
          if(a<1 || b>max){ res.out.push(token); continue; }
          for(let n=a; n<=b; n++){
            if(res.set.has(n)) res.duplicates.add(n);
            else res.set.add(n);
          }
        }else{
          const n = Number(token);
          if(!Number.isFinite(n) || !Number.isInteger(n)){ res.invalid.push(token); continue; }
          if(n<1 || n>max){ res.out.push(token); continue; }
          if(res.set.has(n)) res.duplicates.add(n);
          else res.set.add(n);
        }
      }
      if(res.duplicates.size || res.invalid.length || res.out.length) res.ok=false;
      return res;
    }

    function calcCols(){
      const w = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
      if (w >= 980) return 14;
      if (w >= 760) return 12;
      if (w >= 520) return 10;
      return 8;
    }

    function getCurrentState(){
      const state = loadState() || defaultState();
      state.date = elDate.value || state.date || todayISO();
      state.max = Math.max(1, Number(elMaxNum.value || state.max || 100));
      state.hide = elHide.value ?? state.hide ?? "";
      state.on = state.on || {};
      return state;
    }

    function updateCount(){
      elCountOn.textContent = String(elGrid.querySelectorAll(".cell.on").length);
    }

    function showError(v){
      if(v.ok){
        elHideMsg.classList.remove("show");
        elHideMsg.textContent = "";
        elApply.disabled = false;
        return;
      }
      const msgs = [];
      if(v.invalid.length) msgs.push(`不正: ${v.invalid.join(", ")}`);
      if(v.out.length) msgs.push(`範囲外(1〜${getMax()}): ${v.out.join(", ")}`);
      if(v.duplicates.size){
        const d = Array.from(v.duplicates).sort((a,b)=>a-b);
        msgs.push(`重複/かぶり: ${d.join(", ")}`);
      }
      elHideMsg.textContent = msgs.join(" / ");
      elHideMsg.classList.add("show");
      elApply.disabled = true;
    }

    function getMax(){
      return Math.max(1, Number(elMaxNum.value || 1));
    }

    function buildGrid(state){
      const max = state.max;
      const v = validateAndParseHide(state.hide, max);
      const hideSet = v.set;

      for(const k of Object.keys(state.on)){
        const n = Number(k);
        if(!Number.isFinite(n) || n < 1 || n > max || hideSet.has(n)){
          delete state.on[k];
        }
      }

      elGrid.style.setProperty("--cols", calcCols());
      elGrid.innerHTML = "";

      for(let n=1; n<=max; n++){
        if(hideSet.has(n)) continue;

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className = "cell" + (state.on[n] ? " on" : "");
        btn.textContent = String(n);

        btn.addEventListener("click", () => {
          const s = getCurrentState();
          const vv = validateAndParseHide(s.hide, s.max);
          showError(vv);
          if(!vv.ok) return;

          btn.classList.toggle("on");
          const isOn = btn.classList.contains("on");
          if(isOn) s.on[n] = true;
          else delete s.on[n];

          saveState(s);
          updateCount();
        });

        elGrid.appendChild(btn);
      }

      saveState(state);
      updateCount();
    }

    function apply(){
      const state = getCurrentState();
      const v = validateAndParseHide(state.hide, state.max);
      showError(v);
      if(!v.ok) return;
      saveState(state);
      buildGrid(state);
    }

    function liveValidate(){
      const v = validateAndParseHide(elHide.value, getMax());
      showError(v);
    }

    (function init(){
      let state = loadState();
      if(!state){
        state = defaultState();
        saveState(state);
      }
      elDate.value = state.date || todayISO();
      elMaxNum.value = state.max ?? 100;
      elHide.value = state.hide ?? "";

      liveValidate();
      const v = validateAndParseHide(elHide.value, Number(elMaxNum.value));
      if(v.ok) buildGrid(state);
      else buildGrid({ ...state, hide: "" });
    })();

    elDate.addEventListener("change", apply);
    elMaxNum.addEventListener("input", liveValidate);
    elHide.addEventListener("input", liveValidate);
    elApply.addEventListener("click", apply);

    elReset.addEventListener("click", () => {
      const state = getCurrentState();
      const v = validateAndParseHide(state.hide, state.max);
      showError(v);
      if(!v.ok) return;

      state.on = {};
      saveState(state);
      buildGrid(state);
    });

    window.addEventListener("resize", () => {
      const state = getCurrentState();
      const v = validateAndParseHide(state.hide, state.max);
      showError(v);
      if(!v.ok) return;
      buildGrid(state);
    });

    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("/lite-task/sw.js").catch(()=>{});
    }
  </script>
</body>
</html>
